## このプロジェクトの使い方（How To）

本プロジェクトは「条件付き市場（Conditional Funding Market: CFM）」の考え方を学ぶための、クライアントサイドのみのシミュレーション UI です。React + Vite で動作し、LMSR を用いた価格・原価計算により、トレードのコストと市場価格が一貫して決まります。

- 開発者: tkgshn（@0xtkgshn）
- ソースコード: https://github.com/tkgshn/cfm

---

## 何ができるか

- 4つのプロジェクト（アスコエ / Civichat / お悩みハンドブック / みつもりヤドカリくん）について、資金を「1億円」投資した場合（Funded）と、投資しなかった場合（Not funded）の1カ月後の「月間申請件数」を予測します。
- 各プロジェクトには Funded / Not funded の2つの市場があり、どちらの市場でも UP（上がる）/ DOWN（下がる）を売買できます。
- 市場価格は 0〜1 の確率を表し、UI 上では「市場予想: 1億円を投資された場合／市場予想: 投資されなかった場合」として、その時点の想定値（絶対値）も表示されます。
- 右サイドの取引パネルから、プロジェクト・シナリオ・サイド・金額を指定して素早く売買できます。
- ヘッダーの残高をクリックすると、ポートフォリオページで自分の保有ポジションを一覧確認できます。

---

## 画面構成と操作

### 1. ホーム（マーケット一覧）

- 「条件付き市場のシミュレーション」という見出しと、マーケット一覧（カード）が表示されます。
- カードをクリックすると当該マーケットの詳細ページに遷移します。
- 各カードにはプロジェクト名と「forecasted impact（Funded と Not funded の差分のプレビュー）」を表示します。

### 2. マーケット詳細

- ページ上部に市場タイトルと市場の概要を表示します。
- 左カラム
  - 各プロジェクトの予測インパクト推移（折れ線）
  - 「各プロジェクトの推移」カード群（プロジェクト別の Funded/Not funded の推移）
  - 任意でプロジェクトを選ぶと、そのプロジェクトのみの詳細チャートに切り替わります。
- 右カラム（取引パネル）
  - プロジェクト選択 / シナリオ選択（Funded / Not funded）
  - 「市場予想: 1億円を投資された場合／市場予想: 投資されなかった場合」を数値（件）で表示
  - サイド選択（UP / DOWN）
  - 金額入力とショートカット（-1 / +1 / +10 / Max）
  - 金額に基づく「シェア量」「コスト」、スライダーで仮定した結果値における損益プレビュー
  - 取引ボタン（選択した条件で購入）
  - 下部に「あなたのポジション（全プロジェクト）」の一覧（Funded/Not funded × UP/DOWN）

### 3. ポートフォリオ

- ヘッダー右側の「残高」をクリックすると `#portfolio` に遷移します。
- 「あなたのポジション（全プロジェクト）」をカード1枚で一覧表示します。Funded/Not funded × UP/DOWN の保有量を確認できます。

---

## 売買の考え方（LMSR 概要）

- 本UIでは LMSR（Logarithmic Market Scoring Rule）を用いて、連続的に売買可能な自動マーケットメイカーを表現しています。
- 価格は保有量 `qUp` / `qDown` とパラメータ `b` から `priceUp = e^{qUp/b} / (e^{qUp/b} + e^{qDown/b})` で決まり、コストは `C = b * log(e^{qUp/b} + e^{qDown/b})` の差分で計算されます。
- 右パネルの「金額」によって裏側で最適なシェア量を数値的に探索し、同額で購入できる最大シェアを自動計算してから注文を実行します。
- 価格が 0〜1 の確率を表すため、UI ではプロジェクトごとのレンジ（0〜10,000件）に線形換算し、絶対値としても読み取れるようにしています。

---

## 管理者機能（デモ用）

- `Admin` アカウントを選択すると、上部に管理者パネルが表示されます。
- 「指定時点の Impact 最大プロジェクトを確定」で助成先を固定（Winner）できます。
- 「解決・精算」では、プロジェクト別の Funded / Not funded の実測値（絶対値）を入力し、清算を実行できます。

---

## よくある質問

- UP と DOWN の違いは？
  - UP は「結果が市場予想より高くなる（確率が上がる）」に賭ける、DOWN はその逆に賭けます。
- どの単位で取引していますか？
  - 通貨はデモ上の USDC を想定。保有量は「シェア」として表示されます。
- 予測インパクトとは？
  - Funded と Not funded の想定値の差分（件数）。左上のチャートで時間推移を確認できます。

---

## 補足（開発者向け）

- 主要なロジックは `frontend/src/pages/MarketPage.tsx` にあります（LMSR 関数、取引UI、履歴、管理者処理など）。
- 市場メタデータは `frontend/src/lib/markets.ts`。ホームのカードは `frontend/src/pages/Home.tsx`。
- ポートフォリオは `frontend/src/pages/Portfolio.tsx`。保有一覧カードは `frontend/src/components/UserPositionsAllCard.tsx`。

